build-runtime: true
id: org.wine.Sdk
id-platform: org.wine.Platform
branch: &app-version '10.7'
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '24.08'
finish-args:
  - --sdk=org.wine.Sdk//10.7
  - --runtime=org.wine.Platform//10.7
  - --socket=pcsc # Child apps will need to enable this to access smartcards

sdk-extensions:
  # - org.freedesktop.Sdk.Debug
  # - org.freedesktop.Sdk.Locale
  # - org.freedesktop.Sdk.Docs
  - org.freedesktop.Sdk.Compat.i386              # Needed for building 32bit Wine
  - org.freedesktop.Sdk.Extension.toolchain-i386 # Needed for building 32bit Wine
  - org.freedesktop.Sdk.Extension.mingw-w64      # Needed for cross-compiling 32/64bit Wine (Compiling Wine Windows dlls)

# platform-extensions:
#   - org.freedesktop.Platform.Locale

inherit-extensions:
  # Re-export org.freedesktop.Platform extensions for child Apps to inherit
  - org.freedesktop.Platform.GL          # OpenGL
  - org.freedesktop.Platform.VAAPI.Intel # Intel VAAPI
  - org.freedesktop.Platform.VulkanLayer
  - org.freedesktop.Platform.Timezones
  - org.freedesktop.Platform.GStreamer
  - org.freedesktop.Platform.openh264
  - org.freedesktop.Platform.Icontheme

# inherit-sdk-extensions:
#   - org.freedesktop.Sdk.Extension

add-extensions:
  # Re-export org.freedesktop.Platform extensions for child Apps to inherit
  org.freedesktop.Platform.Compat.i386:       # 32bit Linux compatibility
    directory: lib/i386-linux-gnu
    version: *runtime-version

  org.freedesktop.Platform.Compat.i386.Debug: # 32bit Linux compatibility debug
    directory: lib/debug/lib/i386-linux-gnu
    version: *runtime-version
    no-autodownload: true

  org.freedesktop.Platform.GL32:              # 32bit OpenGL
    directory: lib/i386-linux-gnu/GL
    version: '1.4'
    versions: 24.08;1.4
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;egl/egl_external_platform.d;OpenCL/vendors;lib/dri;lib/d3d;lib/gbm;vulkan/explicit_layer.d;vulkan/implicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.GL32.Debug:        # 32bit OpenGL Debug
    directory: lib/debug/lib/i386-linux-gnu/GL
    version: '1.4'
    versions: 24.08;1.4
    subdirectories: true
    no-autodownload: true
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;egl/egl_external_platform.d;OpenCL/vendors;lib/dri;lib/d3d;lib/gbm;vulkan/explicit_layer.d;vulkan/implicit_layer.d
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.VAAPI.Intel.i386:  # 32bit Intel VAAPI
    directory: lib/i386-linux-gnu/dri/intel-vaapi-driver
    version: *runtime-version
    versions: *runtime-version
    autodelete: false
    no-autodownload: true
    add-ld-path: lib
    download-if: have-intel-gpu
    autoprune-unless: have-intel-gpu

  org.freedesktop.Platform.ffmpeg-full:       # FFmpeg
    directory: lib/ffmpeg
    add-ld-path: .
    version: *runtime-version
    autodelete: false

  org.freedesktop.Platform.ffmpeg_full.i386:  # 32bit FFmpeg
    directory: lib32/ffmpeg
    add-ld-path: .
    version: *runtime-version
    autodelete: false

# cleanup-commands:
#   - /usr/libexec/freedesktop-post.sh # Pre-packaged script that sets up stuff (Not sure if still required)

# cleanup-platform-commands:
#   - /usr/libexec/freedesktop-post.sh # Pre-packaged script that sets up stuff (Not sure if still required)

# YAML Anchor for 32bit build options, to be referred to by 32bit modules below (Avoids needing to rewrite this out for each 32bit module)
x-compat-i386-build-options: &compat-i386-build-options
  prepend-path: /usr/lib/sdk/toolchain-i386/bin                                   # /usr/lib/sdk/toolchain-i386/bin contains gnu 32bit libs needed for compiling
  prepend-pkg-config-path: /usr/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig # Make sure 32-bit dependencies are first on pkg-config search path
  libdir: /usr/lib32                                                              # Install libraries in /usr/lib32
  ldflags: -L/usr/lib32                                                           # Add /usr/lib32 to linker search path for modules without pkg-config
  env:
    CC: ccache i686-unknown-linux-gnu-gcc  # Compile C with GCC using ccache
    CXX: ccache i686-unknown-linux-gnu-g++ # Compile C++ with G++ using ccache
    x86_64_CC: ccache i686-w64-mingw32-gcc # Cross-compile C with x86_64-w64-mingw32-gcc using ccache

modules:
  # Setting up required stuff
  - name: Setup
    buildsystem: simple
    build-commands:
      - |
        # Make directories needed by extensions
        mkdir -p ${FLATPAK_DEST}/lib/i386-linux-gnu              # 32bit Linux compatibility
        mkdir -p ${FLATPAK_DEST}/lib/debug/lib/i386-linux-gnu    # 32bit Linux compatibility debug
        mkdir -p ${FLATPAK_DEST}/lib/debug/lib/i386-linux-gnu/GL # 32bit OpenGL Debug
        mkdir -p ${FLATPAK_DEST}/lib/ffmpeg                      # FFmpeg
        mkdir -p ${FLATPAK_DEST}/lib32/ffmpeg                    # 32bit FFmpeg

        # Make directories needed by modules
        mkdir -p /usr/share/runtime/docs/man                     # /usr/share/man symlinks here but it is not created by default and can cause errors when building modules
        mkdir -p /usr/share/runtime/docs/info                    # /usr/share/info symlinks here but it is not created by default and can cause errors when building modules
        mkdir -p /usr/share/runtime/docs/doc                     # /usr/share/doc symlinks here but it is not created by default and can cause errors when building modules
        mkdir -p /usr/share/runtime/docs/ri                      # /usr/share/ri symlinks here but it is not created by default and can cause errors when building modules

  # TODO: Add module for libOSMesa
  # TODO: Add module for OSS
  # TODO: Add module for libcapi20
  # TODO: Add module for libkrb5
  # TODO: Add module for libnetapi

  # For parallel programming (Optional Wine dependency)
  - name: OpenCL
    sources:
      - type: git
        url: https://github.com/KhronosGroup/OpenCL-Headers.git
        tag: v2024.10.24
        commit: 4ea6df132107e3b4b9407f903204b5522fdffcd6
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^v(\d[\d\.]+\d)$ # Regex pattern that matches latest git tag and compares it to source
    buildsystem: cmake

  # For handling network traffic/packet capture (Optional Wine dependency)
  - name: Libpcap
    sources: &libpcap-sources
      - type: git
        url: https://github.com/the-tcpdump-group/libpcap
        tag: 'libpcap-1.10.5'
        commit: bbcbc9174df3298a854daee2b3e666a4b6e5383a
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^libpcap-(\d[\d\.]+\d)$ # Regex pattern that matches latest git tag and compares it to source

  - name: Libpcap-32
    sources: *libpcap-sources # Reuse &libpcap-sources anchor from above
    build-options:
      arch:
        x86_64: *compat-i386-build-options # Use &compat-i386-build-options anchor from above

  # Middleware for access smart cards (Optional Wine dependency)
  - name: Libpcsclite
    sources: &libpcsclite-sources
      - type: archive
        url: https://pcsclite.apdu.fr/files/pcsc-lite-2.3.3.tar.xz
        sha256: cdff7d7153a0b37aa74e26dfec89ec7dc5c5286aa21b91b903e38739d227e8e7
        x-checker-data:                                                                             # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: html
          url: https://pcsclite.apdu.fr/files/                                                      # Use this file to...
          pattern: (pcsc-lite-(\d[\d\.]+\d).tar.xz)                                                 # Search for this regex pattern and compare it to source to see if there is a newer version
    config-opts: &libpcsclite-config-opts
      - --disable-polkit # Disable polkit dependency

  - name: Libpcsclite-32
    sources: *libpcsclite-sources         # Reuse &libpcsclite-sources anchor from above
    config-opts: *libpcsclite-config-opts # Reuse &libpcsclite-config-opts anchor from above
    build-options:
      arch:
        x86_64: *compat-i386-build-options # Use &compat-i386-build-options anchor from above

  # For handling scanners (Optional Wine dependency)
  - name: Libsane
    sources: &libsane-sources
      - type: git
        url: https://gitlab.com/sane-project/backends.git
        tag: 1.3.1
        commit: 3ff55fd8ee04ae459e199088ebe11ac979671d0e
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^(\d[\d\.]+\d)$ # Regex pattern that matches latest git tag and compares it to source

  - name: Libsane-32
    sources: *libsane-sources
    build-options:
      arch:
        x86_64: *compat-i386-build-options # Use &compat-i386-build-options anchor from above

  # For handling USB devices (Optional Wine dependency)
  - name: Libusb
    sources: &libusb-sources
      - type: git
        url: https://github.com/libusb/libusb.git
        tag: v1.0.28
        commit: a61afe5f75d969c4561a1d0ad753aa23cee6329a
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^v(\d[\d\.]+\d)$ # Regex pattern that matches latest git tag and compares it to source

  - name: Libusb-32
    sources: *libusb-sources
    build-options:
      arch:
        x86_64: *compat-i386-build-options # Use &compat-i386-build-options anchor from above

  # TODO: Add x-checker-data for archived release
  # For handling digital cameras (Optional Wine dependency)
  - name: libgphoto2
    sources: &libgphoto2-sources
      - type: archive
        url: https://github.com/gphoto/libgphoto2/releases/download/v2.5.31/libgphoto2-2.5.31.tar.xz
        sha256: 8fc7bf40f979459509b87dd4ff1aae9b6c1c2b4724d37db576081eec15406ace
      # - type: git
      #   url: https://github.com/gphoto/libgphoto2.git
      #   tag: v2.5.31
      #   commit: ba28af2d22fd4cb7fa76a8ff569ba498e8021db5
      #   x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
      #     type: git
      #     tag-pattern: ^v(\d[\d\.]+\d)$ # Regex pattern that matches latest git tag and compares it to source
      # Patch that allows building with stricter GCC 14 compiler
      - type: patch
        path: Patches/libgphoto-gcc14.patch
    # buildsystem: simple
    # build-commands:
    #   - |
    #     # autoreconf -is
    #     ./configure --prefix=${FLATPAK_DEST}
    #     make
    #     make install

  # TODO: Figure out why installing this 32bit module overwrites 64bit install above when using the git source (Seems to install into /usr/lib/libgphoto2 even tho compat-i386-build-options specify /usr/lib32)
  - name: libgphoto2-32
    sources: *libgphoto2-sources
    build-options:
      arch:
        x86_64: *compat-i386-build-options # Use &compat-i386-build-options anchor from above
    # buildsystem: simple
    # build-commands:
    #   - |
    #     # autoreconf -is
    #     ./configure --prefix=${FLATPAK_DEST}
    #     make
    #     make install

  # This module builds both Wine64 and Wine32 (needed for WoW64 Wine mode) and so looks much different then other modules that build 64/32bit versions seperately and does not use any YAML compat anchors from above
  - name: Wine
    sources:
      - type: git
        url: https://gitlab.winehq.org/wine/wine.git
        tag: 'wine-10.7'
        commit: 71c6c3dd6dcfffc040aa5a10a825eeb8e17f6299
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^wine-(\d+\.\d+)$ # Regex pattern that matches latest git tag and compares it to source
          is-main-source: true

      - type: git
        url: https://gitlab.winehq.org/wine/wine-staging.git
        tag: 'v10.7'
        commit: edfe4935ff2351bd90d4acb03ff6482c02556024
        dest: WineStaging
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^v(\d+\.\d+)$ # Regex pattern that matches latest git tag and compares it to source
          
      - type: file
        path: org.wine.Sdk.metainfo.xml

      - type: file
        path: org.wine.Platform.metainfo.xml

    buildsystem: simple
    build-commands:
      - |
        PATH=$PATH:/usr/lib/sdk/mingw-w64/bin:/usr/lib/sdk/toolchain-i386/bin # Add to PATH, /usr/lib/sdk/mingw-w64/bin contains x86_64-w64-mingw32-gcc and i686-w64-minigw32-gcc compilers from sdk-extension org.freedesktop.Sdk.Extension.mingw-w64, and /usr/lib/sdk/toolchain-i386/bin contains gnu 32bit libs (needed for building the 32bit version of Wine) from org.freedesktop.Sdk.Extension.toolchain-i386

        WineStaging/staging/patchinstall.py DESTDIR="./" --all # Apply Wine Staging patches to Wine before building

        mkdir wine64 # Make directory for building 64bit Wine
        mkdir wine32 # Make directory for building 32bit Wine

        cd wine64
        ../configure                                `# Generate makefile with following flags` \
          --prefix=${FLATPAK_DEST}                  `# Set prefix to Flatpak root (/usr for an SDK)` \
          --enable-win64                            `# Set flag to compile Windows 64bit version` \
          --with-x                                  `# Set flag to compile with X11` \
          --with-wayland                            `# Set flag to compile with Wayland` \
          --with-pulse                              `# Set flag to compile with Pulse audio` \
          --with-dbus                               `# Set flag to compile with Dbus` \
          CC="ccache gcc"                           `# Compile C with GCC using ccache` \
          CXX="ccache g++"                          `# Compile C++ with G++ using ccache` \
          x86_64_CC="ccache x86_64-w64-mingw32-gcc" `# Cross-compile C with x86_64-w64-mingw32-gcc using ccache`
        make -j`nproc --ignore=2`                    # Build 64bit Wine using number of available cores minus 2
        make install
        cd ..

        cd wine32
        ../configure                                                                              `# Generate makefile with following flags` \
          --prefix=${FLATPAK_DEST}                                                                `# Set prefix to Flatpak root (/usr for an SDK)` \
          --with-wine64=../wine64                                                                 `# Use built 64bit Wine above` \
          --with-x                                                                                `# Set flag to compile with X11` \
          --with-wayland                                                                          `# Set flag to compile with Wayland` \
          --with-pulse                                                                            `# Set flag to compile with Pulse audio` \
          --with-dbus                                                                             `# Set flag to compile with Dbus` \
          PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig `# Add locations to search for pkgconfig (Needed for optional 32bit glib-2.0 Wine dependency)` \
          LDFLAGS="-L/usr/lib32"                                                                  `# Add /usr/lib32 to linker search path ` \
          CC="ccache i686-unknown-linux-gnu-gcc"                                                  `# Compile C with GCC using ccache` \
          CXX="ccache i686-unknown-linux-gnu-g++"                                                 `# Compile C++ with G++ using ccache` \
          x86_64_CC="ccache i686-w64-mingw32-gcc"                                                 `# Cross-compile C with x86_64-w64-mingw32-gcc using ccache`
        make -j`nproc --ignore=2`                                                                  # Build 32bit Wine using number of available cores minus
        make install
        cd ..

        install -Dm644 org.wine.Sdk.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo/      # Install SDK metainfo
        install -Dm644 org.wine.Platform.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo/ # Install Platform metainfo

  # Wine addon that allows opening website content
  - name: WineGecko
    sources:
      - type: archive
        url: https://dl.winehq.org/wine/wine-gecko/2.47.4/wine-gecko-2.47.4-x86.tar.xz
        sha256: 2cfc8d5c948602e21eff8a78613e1826f2d033df9672cace87fed56e8310afb6
        strip-components: 0
        # TODO: Keeps tabs that the URL below is good for getting the correct latest version (URL below uses the master version of Wine not the specific version used above and could possibly update Wine Gecko to a newer version before the used Wine version is ready)
        x-checker-data:                                                                               # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: html
          url: https://gitlab.winehq.org/wine/wine/-/raw/master/dlls/appwiz.cpl/addons.c              # Use this file to...
          version-pattern: GECKO_VERSION\s+"(\d[\d\.]+\d)"                                            # Search for this regex pattern
          url-template: https://dl.winehq.org/wine/wine-gecko/$version/wine-gecko-$version-x86.tar.xz # Compare this file (found using regex match from above) to the source to see if there is a newer version

      - type: archive
        url: https://dl.winehq.org/wine/wine-gecko/2.47.4/wine-gecko-2.47.4-x86_64.tar.xz
        sha256: fd88fc7e537d058d7a8abf0c1ebc90c574892a466de86706a26d254710a82814
        strip-components: 0
        # TODO: Keeps tabs that the URL below is good for getting the correct latest version (URL below uses the master version of Wine not the specific version used above and could possibly update Wine Gecko to a newer version before the used Wine version is ready)
        x-checker-data:                                                                                  # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: html
          url: https://gitlab.winehq.org/wine/wine/-/raw/master/dlls/appwiz.cpl/addons.c                 # Use this file to...
          version-pattern: GECKO_VERSION\s+"(\d[\d\.]+\d)"                                               # Search for this regex pattern
          url-template: https://dl.winehq.org/wine/wine-gecko/$version/wine-gecko-$version-x86_64.tar.xz # Compare this file (found using regex match from above) to the source to see if there is a newer version

    buildsystem: simple
    build-commands:
      - |
        mkdir -p ${FLATPAK_DEST}/share/wine/gecko/           # Make direcory path for Wine Gecko
        cp -a wine-gecko-* ${FLATPAK_DEST}/share/wine/gecko/ # Copy Wine Gecko directories keeping file permissions the same

  # Wine addon that replaces the default .NET framework
  - name: WineMono
    sources:
      - type: archive
        url: https://dl.winehq.org/wine/wine-mono/10.0.0/wine-mono-10.0.0-x86.tar.xz
        sha256: b487c444415789a8b25b3a6542afa668a6b6d6067c648626f323884443f7b70d
        strip-components: 0
        # TODO: Keeps tabs that the URL below is good for getting the correct latest version (URL below uses the master version of Wine not the specific version used above and could possibly update Wine Mono to a newer version before the used Wine version is ready)
        x-checker-data:                                                                             # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: html
          url: https://gitlab.winehq.org/wine/wine/-/raw/master/dlls/appwiz.cpl/addons.c            # Use this file to...
          version-pattern: MONO_VERSION\s+"(\d[\d\.]+\d)"                                           # Search for this regex pattern
          url-template: https://dl.winehq.org/wine/wine-mono/$version/wine-mono-$version-x86.tar.xz # Compare this file (found using regex match from above) to the source to see if there is a newer version

    buildsystem: simple
    build-commands:
      - |
        mkdir -p ${FLATPAK_DEST}/share/wine/mono/          # Make direcory path for Wine Mono
        cp -a wine-mono-* ${FLATPAK_DEST}/share/wine/mono/ # Copy Wine Mono directory keeping file permissions the same

  # Tool that can be used to help download and install various libraries, fonts, etc into a Wine prefix
  - name: WineTricks
    sources:
      - type: git
        url: https://github.com/Winetricks/winetricks.git
        tag: '20250102'
        commit: e20b2f6f80d175f96208f51800130db7459dd28c
        x-checker-data: # Checks for a newer version when org.flathub.flatpak-external-data-checker is ran on this file
          type: git
          tag-pattern: ^(\d+)$ # Regex pattern that matches latest git tag and compares it to source

    buildsystem: simple
    build-commands:
      - |
        make install

  # Vulkan based D3D8, 9, 10, and 11 replacement dlls
  # Note: This module just places the DXVK dlls in ${FLATPAK_DEST}/share/dxvk/ and child Apps will have to copy/replace the default Wine dlls with these to make use of DXVK
  - name: DXVK
    sources:
      - type: archive
        url: https://github.com/doitsujin/dxvk/releases/download/v2.6/dxvk-2.6.tar.gz
        sha256: 0d762c33869c46aa85ad563057a9cbe0a247cd5a7d1209e484bdbe7335c77f01

      # Script that switches a Wine prefix to DXVK dlls from the default Wine dlls (Optionally ran by child Apps to update their already initialized Wine prefix)
      - type: file
        path: Scripts/DXVKToWine.sh

      # Script that switches a Wine prefix to the default Wine dlls from DXVK dlls (Optionally ran by child Apps to update their already initialized Wine prefix)
      - type: file
        path: Scripts/WineToDXVK.sh

    buildsystem: simple
    build-commands:
      - |
        mkdir -p ${FLATPAK_DEST}/share/dxvk/                 # Make direcory path for DXVK
        cp -a x32 ${FLATPAK_DEST}/share/dxvk/                # Copy 32bit DXVK keeping file permissions the same
        cp -a x64 ${FLATPAK_DEST}/share/dxvk/                # Copy 64bit DXVK keeping file permissions the same

        install -Dm755 DXVKToWine.sh -t ${FLATPAK_DEST}/bin/ # Install script for switching Wine prefix to DXVK
        install -Dm755 WineToDXVK.sh -t ${FLATPAK_DEST}/bin/ # Install script for switching Wine prefix to default Wine dlls
